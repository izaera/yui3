YUI.add("autocomplete-base",function(r,e){var p=r.Escape,i=r.Lang,n=r.Array,u=r.Object,a=i.isFunction,l=i.isString,o=i.trim,c=r.Attribute.INVALID_VALUE,h="_functionValidator",f="_sourceSuccess",s="allowBrowserAutocomplete",_="inputNode",g="query",d="queryDelimiter",t="results",y="value",v="valueChange",m="clear",R=g,S=t;function b(){}b.prototype={initializer:function(){r.before(this._bindUIACBase,this,"bindUI"),r.before(this._syncUIACBase,this,"syncUI"),this.publish(m,{defaultFn:this._defClearFn}),this.publish(R,{defaultFn:this._defQueryFn}),this.publish(S,{defaultFn:this._defResultsFn})},destructor:function(){this._acBaseEvents&&this._acBaseEvents.detach(),delete this._acBaseEvents,delete this._cache,delete this._inputNode,delete this._rawSource},clearCache:function(){return this._cache&&(this._cache={}),this},sendRequest:function(e,t){var s=this.get("source");return e||""===e?this._set(g,e):e=this.get(g)||"",s&&(t=(t=t||this.get("requestTemplate"))?t.call(this,e):e,s.sendRequest({query:e,request:t,callback:{success:r.bind(this._onResponse,this,e)}})),this},_bindUIACBase:function(){var e=this.get(_),t=e&&e.tokenInput;t&&(e=t.get(_),this._set("tokenInput",t)),e?(this._inputNode=e,this._acBaseEvents=new r.EventHandle([e.on(v,this._onInputValueChange,this),e.on("blur",this._onInputBlur,this),this.after(s+"Change",this._syncBrowserAutocomplete),this.after("sourceTypeChange",this._afterSourceTypeChange),this.after(v,this._afterValueChange)])):r.error("No inputNode specified.")},_syncUIACBase:function(){this._syncBrowserAutocomplete(),this.set(y,this.get(_).get(y))},_createArraySource:function(t){var s=this;return{type:"array",sendRequest:function(e){s[f](t.concat(),e)}}},_createFunctionSource:function(r){var n=this;return{type:"function",sendRequest:function(t){var e;function s(e){n[f](e||[],t)}(e=r(t.query,s))&&s(e)}}},_createObjectSource:function(s){var r=this;return{type:"object",sendRequest:function(e){var t=e.query;r[f](u.owns(s,t)?s[t]:[],e)}}},_functionValidator:function(e){return null===e||a(e)},_getObjectValue:function(e,t){if(e){for(var s=0,r=t.length;e&&s<r;s++)e=e[t[s]];return e}},_parseResponse:function(e,t,s){var r,n,i,u,a,l,o,c,h,s={data:s,query:e,results:[]},f=this.get("resultListLocator"),_=[],g=t&&t.results;if((g=g&&f?f.call(this,g):g)&&g.length){for(r=this.get("resultFilters"),h=this.get("resultTextLocator"),u=0,a=g.length;u<a;++u)o=g[u],c=h?h.call(this,o):o.toString(),_.push({display:p.html(c),raw:o,text:c});for(u=0,a=r.length;u<a;++u){if(!(_=r[u].call(this,e,_.concat())))return;if(!_.length)break}if(_.length){if(t=this.get("resultFormatter"),f=this.get("resultHighlighter"),(l=this.get("maxResults"))&&0<l&&_.length>l&&(_.length=l),f){if(!(i=f.call(this,e,_.concat())))return;for(u=0,a=i.length;u<a;++u)(o=_[u]).highlighted=i[u],o.display=o.highlighted}if(t){if(!(n=t.call(this,e,_.concat())))return;for(u=0,a=n.length;u<a;++u)_[u].display=n[u]}}}s.results=_,this.fire(S,s)},_parseValue:function(e){var t=this.get(d);return t&&(e=(e=e.split(t))[e.length-1]),i.trimLeft(e)},_setEnableCache:function(e){this._cache=e?{}:null},_setLocator:function(t){var s;return this[h](t)?t:(s=this,t=t.toString().split("."),function(e){return e&&s._getObjectValue(e,t)})},_setRequestTemplate:function(t){return this[h](t)?t:(t=t.toString(),function(e){return i.sub(t,{query:encodeURIComponent(e)})})},_setResultFilters:function(e){var t,s;return null===e?[]:(t=r.AutoCompleteFilters,s=function(e){return a(e)?e:!!(l(e)&&t&&a(t[e]))&&t[e]},i.isArray(e)?(e=n.map(e,s),n.every(e,function(e){return!!e})?e:c):(e=s(e))?[e]:c)},_setResultHighlighter:function(e){var t;return this[h](e)?e:(t=r.AutoCompleteHighlighters,l(e)&&t&&a(t[e])?t[e]:c)},_setSource:function(e){var t,s=this.get("sourceType")||i.type(e);return e&&a(e.sendRequest)||null===e||"datasource"===s?this._rawSource=e:(t=b.SOURCE_TYPES[s])?(this._rawSource=e,i.isString(t)?this[t](e):t(e)):(r.error("Unsupported source type '"+s+"'. Maybe autocomplete-sources isn't loaded?"),c)},_sourceSuccess:function(e,t){t.callback.success({data:e,response:{results:e}})},_syncBrowserAutocomplete:function(){var e=this.get(_);"input"===e.get("nodeName").toLowerCase()&&e.setAttribute("autocomplete",this.get(s)?"on":"off")},_updateValue:function(e){var t,s,r=this.get(d);e=i.trimLeft(e),r&&(t=o(r),1<(s=(r=n.map(o(this.get(y)).split(r),o)).length)&&(r[s-1]=e,e=r.join(t+" ")),e=e+t+" "),this.set(y,e)},_afterSourceTypeChange:function(e){this._rawSource&&this.set("source",this._rawSource)},_afterValueChange:function(e){var t,s,r=e.newVal,n=this,i=e.src===b.UI_SRC;i||n._inputNode.set(y,r),t=n.get("minQueryLength"),s=n._parseValue(r)||"",0<=t&&s.length>=t?i?(t=function(){n.fire(R,{inputValue:r,query:s,src:e.src})},(i=n.get("queryDelay"))?(clearTimeout(n._delay),n._delay=setTimeout(t,i)):t()):n._set(g,s):(clearTimeout(n._delay),n.fire(m,{prevVal:e.prevVal?n._parseValue(e.prevVal):null,src:e.src}))},_onInputBlur:function(e){var t,s,r,n=this.get(d);if(n&&!this.get("allowTrailingDelimiter")){if(n=i.trimRight(n),r=s=this._inputNode.get(y),n)for(;(s=i.trimRight(s))&&(t=s.length-n.length)&&s.lastIndexOf(n)===t;)s=s.substring(0,t);else s=i.trimRight(s);s!==r&&this.set(y,s)}},_onInputValueChange:function(e){e=e.newVal;e!==this.get(y)&&this.set(y,e,{src:b.UI_SRC})},_onResponse:function(e,t){e===(this.get(g)||"")&&this._parseResponse(e||"",t.response,t.data)},_defClearFn:function(){this._set(g,null),this._set(t,[])},_defQueryFn:function(e){this.sendRequest(e.query)},_defResultsFn:function(e){this._set(t,e[t])}},b.ATTRS={allowBrowserAutocomplete:{value:!1},allowTrailingDelimiter:{value:!1},enableCache:{lazyAdd:!1,setter:"_setEnableCache",value:!0},inputNode:{setter:r.one,writeOnce:"initOnly"},maxResults:{value:0},minQueryLength:{value:1},query:{readOnly:!0,value:null},queryDelay:{value:100},queryDelimiter:{value:null},requestTemplate:{setter:"_setRequestTemplate",value:null},resultFilters:{setter:"_setResultFilters",value:[]},resultFormatter:{validator:h,value:null},resultHighlighter:{
setter:"_setResultHighlighter",value:null},resultListLocator:{setter:"_setLocator",value:null},results:{readOnly:!0,value:[]},resultTextLocator:{setter:"_setLocator",value:null},source:{setter:"_setSource",value:null},sourceType:{value:null},tokenInput:{readOnly:!0},value:{value:""}},b._buildCfg={aggregates:["SOURCE_TYPES"],statics:["UI_SRC"]},b.SOURCE_TYPES={array:"_createArraySource","function":"_createFunctionSource",object:"_createObjectSource"},b.UI_SRC=r.Widget&&r.Widget.UI_SRC||"ui",r.AutoCompleteBase=b},"@VERSION@",{optional:["autocomplete-sources"],requires:["array-extras","base-build","escape","event-valuechange","node-base"]});